<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <title>Kônsul Billing</title>
  <style>
    :root { --brand-color:#00A99D; --primary-blue:#0d6efd; --light-blue:#e7f1ff; --text-dark:#212529; --text-light:#6c757d; --bg-light:#f8f9fa; --border-color:#dee2e6; --white:#ffffff; --priority-high:#dc3545; --priority-medium:#ffc107; --priority-low:#0dcaf0; --priority-paid:#198754; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif; display:flex; height:100vh; overflow:hidden; background:var(--white); color:var(--text-dark); }
    .container { display:flex; width:100%; height:100%; }
    .sidebar { width:280px; background:var(--bg-light); border-right:1px solid var(--border-color); padding:20px; }
    .main-content { flex:1; display:flex; flex-direction:column; }
    .main-header { padding:20px 30px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; }
    .main-header h1 { font-size:28px; }
    .records-list { flex:1; overflow-y:auto; padding:20px 30px; }
    .logo { margin-bottom:30px; }
    .summary-cards { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:30px; }
    .card { background:var(--white); border:1px solid var(--border-color); border-radius:8px; padding:15px; text-align:center; }
    .card .count { font-size:2em; font-weight:600; }
    .card .label { font-size:0.9em; color:var(--text-light); }
    .filter-list { list-style:none; margin-bottom:20px; }
    .filter-list .list-title { text-transform:uppercase; color:var(--text-light); font-size:0.8em; font-weight:600; margin-bottom:10px; padding-left:10px; }
    .filter-list li { display:flex; align-items:center; padding:10px; border-radius:8px; cursor:pointer; transition:background-color 0.2s; gap:10px; }
    .filter-list li:hover { background:#e9ecef; }
    .filter-list li.active { background:var(--light-blue); color:var(--primary-blue); font-weight:600; }
    .icon-dot { width:12px; height:12px; border-radius:50%; }
    .type-icon { font-family: 'Material Icons'; font-size: 20px; margin-right: 8px; }
    .record-item { display:flex; align-items:center; padding:15px 10px; border-bottom:1px solid var(--border-color); }
    .record-item-main { flex:1; margin-left:15px; }
    .record-description { font-weight:500; }
    .record-details { font-size:0.85em; color:var(--text-light); display:flex; gap:15px; margin-top:5px; }
    .status-tag { padding:3px 8px; border-radius:12px; font-size:0.75em; font-weight:600; color:var(--white); margin-right:8px; }
    .status-Draft { background:var(--text-light); } .status-Sent { background:var(--priority-medium); } .status-Cancelled { background:var(--priority-high); } .status-Paid { background:var(--priority-paid); }
    .record-actions button { background:none; border:1px solid var(--border-color); padding:5px 12px; border-radius:6px; cursor:pointer; transition:all 0.2s; font-weight:500; }
    .record-actions button:hover { background:var(--bg-light); }
        .filter-group { margin-bottom:20px; }
    .filter-group .list-title { text-transform:uppercase; color:var(--text-light); font-size:0.8em; font-weight:600; margin-bottom:10px; padding-left:10px; }
    .filter-group input { width:100%; padding:8px; border:1px solid var(--border-color); border-radius:8px; }
    #date-filter-group label { display:block; margin-top:10px; }
    #date-filter-group input { margin-bottom:10px; }
    .fab { position:absolute; bottom:30px; right:30px; width:56px; height:56px; background:var(--primary-blue); color:#fff; border-radius:50%; border:none; font-size:28px; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.2); cursor:pointer; }
    .fab:hover { transform:scale(1.05); }
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:var(--white); padding:30px; border-radius:12px; width:90%; max-width:500px; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
    .modal-content h2 { margin-bottom:20px; }
    .modal-content p { color:var(--text-light); margin-bottom:15px; font-size:0.9em; }
    .modal-content textarea { width:100%; height:150px; padding:10px; border-radius:8px; border:1px solid var(--border-color); font-family:inherit; font-size:1rem; margin-bottom:20px; }
    .modal-content .field { margin-bottom:15px; }
    .modal-content label { display:block; margin-bottom:5px; font-weight:500; }
    .modal-content input, .modal-content select { width:100%; padding:10px; border-radius:8px; border:1px solid var(--border-color); }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; }
    .btn-cancel { background:#e9ecef; color:var(--text-dark); padding:10px 20px; border:none; border-radius:8px; cursor:pointer; }
    .btn-primary { background:var(--primary-blue); color:#fff; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; }
     .modal-field { margin-bottom:15px; }
    .modal-field label { display:block; margin-bottom:5px; font-size:0.9em; color:var(--text-light); }
    .modal-field input, .modal-field select { width:100%; padding:8px; border:1px solid var(--border-color); border-radius:8px; }
    .loader-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.7); display:none; justify-content:center; align-items:center; z-index:2000; }
    .loader { border:6px solid var(--bg-light); border-top:6px solid var(--brand-color); border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <aside class="sidebar">
      <div class="logo"><!-- Logo SVG --></div>
      <div class="summary-cards">
        <div class="card"><div class="count" id="total-records-count">0</div><div class="label">Todos</div></div>
        <div class="card"><div class="count" id="paid-records-count">0</div><div class="label">Pagados</div></div>
      </div>
       <div class="filter-group" id="text-filter-group">
        <div class="list-title">Buscar</div>
        <input type="text" id="filter-text" placeholder="Nombre o Email" />
      </div>
      <div class="filter-group" id="date-filter-group">
        <div class="list-title">Filtrar por Fecha</div>
         <label for="filter-date-from">Desde:</label>
         <br>
        <input type="date" id="filter-date-from" />
        <label for="filter-date-to">Hasta:</label>
         <br>
        <input type="date" id="filter-date-to" />
      </div>
      <ul class="filter-list" id="status-filters">
        <li class="list-title">Filtrar por Estado</li>
        <li data-filter-type="status" data-filter-value="Cancelled"><span class="icon-dot" style="background-color:var(--priority-high)"></span>Prioridad Alta (Cancelado)</li>
        <li data-filter-type="status" data-filter-value="Sent"><span class="icon-dot" style="background-color:var(--priority-medium)"></span>Prioridad Media (Enviado)</li>
        <li data-filter-type="status" data-filter-value="Paid"><span class="icon-dot" style="background-color:var(--priority-paid)"></span>Completado (Pagado)</li>
      </ul>
      <ul class="filter-list" id="type-filters">
        <li class="list-title">Filtros por Tipo</li>
        <li class="active" data-filter-type="type" data-filter-value="all">Todos los Tipos</li>
        <li data-filter-type="type" data-filter-value="Quote">Cotizaciones</li>
        <li data-filter-type="type" data-filter-value="Invoice">Facturas</li>
      </ul>
    </aside>
    <main class="main-content">
      <header class="main-header"><h1>Facturación</h1></header>
      <div class="records-list" id="records-list-container"></div>
    </main>
  </div>
  <button class="fab" id="add-quote-btn">+</button>
   <div class="modal-overlay" id="new-quote-modal">
      <div class="modal-content">
        <h2>Crear Cotización desde Notas</h2>
      <p>Describe los requerimientos del cliente. La IA generará una descripción y un monto estimado para la cotización.</p>
      <textarea id="quote-notes-input" placeholder="Ej: El cliente necesita una campaña de marketing en redes sociales para 3 meses, enfocada en Instagram y Facebook. Incluir 12 posts y 2 reportes mensuales..."></textarea>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancel-quote-btn">Cancelar</button>
        <button class="btn-primary" id="create-quote-btn">Crear Cotización</button>
      </div>
    </div>
    </div>
  <div class="modal-overlay" id="new-invoice-modal">
        <div class="modal-content">
          <h2>Crear Factura desde Notas</h2>
          <p>Describe los requerimientos del cliente...</p>
          <textarea id="invoice-notes-input" placeholder="..."></textarea>
          <div class="modal-actions">
            <button class="btn-cancel" id="cancel-invoice-btn">Cancelar</button>
            <button class="btn-primary" id="create-invoice-btn">Crear Factura</button>
          </div>
        </div>
      </div>
    <div class="modal-overlay" id="edit-quote-modal">
      <div class="modal-content">
        <h2>Editar Cotización</h2>
        <div class="modal-field"><label>Cliente</label><input type="text" id="edit-client-name"></div>
        <div class="modal-field"><label>Email</label><input type="email" id="edit-client-email"></div>
        <div class="modal-field"><label>Asunto</label><input type="text" id="edit-subject"></div>
        <div class="modal-field"><label>Item</label><input type="text" id="edit-item"></div>
        <div class="modal-field"><label>Monto</label><input type="number" id="edit-amount"></div>
        <div class="modal-field"><label>Estado</label>
         <select id="edit-status"></select>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" id="cancel-edit-btn">Cancelar</button>
          <button class="btn-primary" id="save-edit-btn">Guardar</button>
          <button class="btn-primary" id="transform-to-invoice-btn">
            Transformar a Factura
          </button>
        </div>
      </div>
    </div>
    <div class="loader-overlay" id="loader"><div class="loader"></div></div>
    <script>
      let allRecords = [];
    let currentFilters = { status: null, type: 'all', dateFrom: null, dateTo: null };
    let editingId = null;
    document.addEventListener('DOMContentLoaded', () => {
      fetchRecords();
      setupEventListeners();
      setInterval(fetchRecords, 30*60*1000);
    });
    function setupEventListeners() {
      document.getElementById('status-filters').addEventListener('click', handleFilterClick);
      document.getElementById('type-filters').addEventListener('click', handleFilterClick);
      document.getElementById('filter-date-from').addEventListener('change', e => {
          currentFilters.dateFrom = e.target.value || null;
          applyFiltersAndRender();
        });
        document.getElementById('filter-date-to').addEventListener('change', e => {
          currentFilters.dateTo = e.target.value || null;
          applyFiltersAndRender();
        });
      document.getElementById('filter-text').addEventListener('input', e => {
        currentFilters.query = e.target.value.trim().toLowerCase();
        applyFiltersAndRender();
      });
      document.getElementById('add-quote-btn').addEventListener('click', () => document.getElementById('new-quote-modal').style.display = 'flex');
        document.getElementById('add-invoice-btn').addEventListener('click', () => document.getElementById('new-invoice-modal').style.display = 'flex');
        document.getElementById('cancel-quote-btn').addEventListener('click', () => document.getElementById('new-quote-modal').style.display = 'none');
        document.getElementById('cancel-invoice-btn').addEventListener('click', () => document.getElementById('new-invoice-modal').style.display = 'none');
        document.getElementById('create-quote-btn').addEventListener('click', () => {
          const notes = document.getElementById('quote-notes-input').value.trim();
          if (!notes) return alert('Introduce detalles');
          showLoader();
          document.getElementById('new-quote-modal').style.display = 'none';
          const timeoutId = startTimeout();
          google.script.run
            .withSuccessHandler(() => {
              clearTimeout(timeoutId);
              fetchRecords();
            })
            .withFailureHandler(err => {
              clearTimeout(timeoutId);
              hideLoader();
              alert(err.message);
            })
            .createQuoteFromNotes(notes);
        });
        document.getElementById('create-invoice-btn').addEventListener('click', () => {
          const notes = document.getElementById('invoice-notes-input').value.trim();
          if (!notes) return alert('Introduce detalles');
          showLoader();
          document.getElementById('new-invoice-modal').style.display = 'none';
          const timeoutId = startTimeout();
          google.script.run
            .withSuccessHandler(() => {
              clearTimeout(timeoutId);
              fetchRecords();
            })
            .withFailureHandler(err => {
              clearTimeout(timeoutId);
              hideLoader();
              alert(err.message);
            })
            .createInvoiceFromNotes(notes);
        });
        document.getElementById('save-edit-btn').addEventListener('click', saveQuoteEdits);
        document.getElementById('cancel-edit-btn').addEventListener('click', () => document.getElementById('edit-quote-modal').style.display = 'none');
        document.getElementById('transform-to-invoice-btn').addEventListener('click', triggerTransform);
      }
    function showLoader() { document.getElementById('loader').style.display = 'flex'; }
    function hideLoader() { document.getElementById('loader').style.display = 'none'; }
    function startTimeout() {
      return setTimeout(() => {
        hideLoader();
        alert('Error: la solicitud tardó demasiado.');
      }, 30000);
    }
    function fetchRecords() {
      showLoader();
      const timeoutId = startTimeout();
      google.script.run
        .withSuccessHandler(records => {
          clearTimeout(timeoutId);
          allRecords = records;
          applyFiltersAndRender();
          hideLoader();
        })
        .withFailureHandler(err => {
          clearTimeout(timeoutId);
          hideLoader();
          alert(err.message);
        })
        .getBillingRecords();
    }
    function handleFilterClick(e) {
      const li = e.target.closest('li[data-filter-type]'); if (!li) return;
      const type = li.dataset.filterType, value = li.dataset.filterValue;
      if (type === 'status') currentFilters.status = currentFilters.status === value ? null : value;
      else currentFilters.type = value;
      document.querySelectorAll(`#${type}-filters li`).forEach(x => x.classList.toggle('active', x.dataset.filterValue === currentFilters[type]));
      applyFiltersAndRender();
    }
    function applyFiltersAndRender() {
      const quoteBtn = document.getElementById('add-quote-btn');
      const invoiceBtn = document.getElementById('add-invoice-btn');
      quoteBtn.style.display = (currentFilters.type === 'Quote' || currentFilters.type === 'all') ? 'flex' : 'none';
      invoiceBtn.style.display = (currentFilters.type === 'Invoice' || currentFilters.type === 'all') ? 'flex' : 'none';
      let recs = [...allRecords];
      if (currentFilters.status) recs = recs.filter(r => r.status === currentFilters.status);
      if (currentFilters.type !== 'all') recs = recs.filter(r => r.type === currentFilters.type);
      if (currentFilters.dateFrom || currentFilters.dateTo) {
          recs = recs.filter(r => {
            if (!r.quoteDate) return false;
            return (!currentFilters.dateFrom || r.quoteDate >= currentFilters.dateFrom) &&
                   (!currentFilters.dateTo || r.quoteDate <= currentFilters.dateTo);
          });
        }
      if (currentFilters.query) {
        const q = currentFilters.query;
        recs = recs.filter(r =>
          (r.clientName && r.clientName.toLowerCase().includes(q)) ||
          (r.clientEmail && r.clientEmail.toLowerCase().includes(q))
        );
      }
      renderRecords(recs);
      document.getElementById('total-records-count').textContent = allRecords.length;
      document.getElementById('paid-records-count').textContent = allRecords.filter(r => r.status === 'Paid').length;
    }
    function renderRecords(records) {
      const c = document.getElementById('records-list-container'); c.innerHTML = '';
      if (!records.length) return c.innerHTML = '<p style="color:var(--text-light);text-align:center;padding:40px;">No registros</p>';
      records.forEach(r => {
        const div = document.createElement('div');
        div.className = 'record-item';
        div.dataset.id = r.id;
        const mainDesc = r.description || r.subject || r.item || '';
        const actions = [];
        if (r.type==='Quote') {
          actions.push(`<button onclick="openEditModal('${r.id}')">✏️ Editar</button>`);
          if (r.status==='Draft') actions.push(`<button onclick="sendQuote('${r.id}')">✉️ Enviar</button>`);
          } else if (r.type === 'Invoice') {
          actions.push(`<button onclick="openEditModal('${r.id}')">✏️ Editar</button>`);
          if (r.status === 'Draft') actions.push(`<button onclick="sendInvoice('${r.id}')">✉️ Enviar</button>`);
        }
        const icon = r.type === 'Quote' ? 'request_quote' : 'receipt_long';
        div.innerHTML = `
        <span class="type-icon">${icon}</span>
          <div class="record-item-main">
            <div class="record-description">${mainDesc}</div>
            <div class="record-details">
              
              <span><strong>ID:</strong> ${r.id}</span>
               <span><strong>Cliente:</strong> ${r.clientName || 'Por Actualizar'}</span>
              <span><strong>Email:</strong> ${r.clientEmail || 'N/A'}</span>
              ${r.quoteDate ? `<span><strong>Fecha:</strong> ${r.quoteDate}</span>` : ''}
              <span><strong>Monto:</strong> $${r.amount}</span>
              
            </div>
          </div>
           <div class="status-tag status-${r.status}">${r.status}</div>
         <div class="record-actions">${actions.join(' ')}</div>
        `;
        c.appendChild(div);
      });
    }
    function sendQuote(id) {
      showLoader();
      const timeoutId = startTimeout();
      google.script.run
        .withSuccessHandler(() => {
          clearTimeout(timeoutId);
          fetchRecords();
        })
        .withFailureHandler(err => {
          clearTimeout(timeoutId);
          hideLoader();
          alert(err.message);
        })
        .sendQuote(id);
    }
    function sendInvoice(id) {
      showLoader();
      const timeoutId = startTimeout();
      google.script.run
        .withSuccessHandler(() => {
          clearTimeout(timeoutId);
          fetchRecords();
        })
        .withFailureHandler(err => {
          clearTimeout(timeoutId);
          hideLoader();
          alert(err.message);
        })
        .sendInvoice(id);
    }
     function openEditModal(id) {
        const rec = allRecords.find(r => r.id===id);
        if (!rec) return;
        editingId = id;
        const statusSelect = document.getElementById('edit-status');
        statusSelect.innerHTML = '';
        const statuses = rec.type === 'Quote'
          ? ['Draft','Sent']
          : ['Draft','Sent','Paid','Cancelled'];
        statuses.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = s;
          statusSelect.appendChild(opt);
        });
        document.getElementById('edit-client-name').value = rec.clientName || '';
        document.getElementById('edit-client-email').value = rec.clientEmail || '';
        document.getElementById('edit-subject').value = rec.subject || '';
        document.getElementById('edit-item').value = rec.item || '';
        document.getElementById('edit-amount').value = rec.amount || '';
        statusSelect.value = statuses.includes(rec.status) ? rec.status : 'Draft';
        const transformBtn = document.getElementById('transform-to-invoice-btn');
        transformBtn.style.display = rec.type === 'Invoice' ? 'none' : 'inline-block';
        document.getElementById('edit-quote-modal').style.display = 'flex';
      }
    function saveQuoteEdits() {
      if (!editingId) return;
      const data = {
        id: editingId,
        clientName: document.getElementById('edit-client-name').value.trim(),
        clientEmail: document.getElementById('edit-client-email').value.trim(),
        subject: document.getElementById('edit-subject').value.trim(),
        item: document.getElementById('edit-item').value.trim(),
        amount: parseFloat(document.getElementById('edit-amount').value) || 0,
        status: document.getElementById('edit-status').value
      };
      showLoader();
      document.getElementById('edit-quote-modal').style.display = 'none';
      const timeoutId = startTimeout();
      google.script.run
        .withSuccessHandler(() => {
          clearTimeout(timeoutId);
          fetchRecords();
        })
        .withFailureHandler(err => {
          clearTimeout(timeoutId);
          hideLoader();
          alert(err.message);
        })
        .updateQuote(data);
    }
     function triggerTransform() {
      if (!editingId) return;
      showLoader();
      document.getElementById('edit-quote-modal').style.display = 'none';
      const timeoutId = startTimeout();
      google.script.run
        .withSuccessHandler(() => {
          clearTimeout(timeoutId);
          fetchRecords();
          hideLoader();
        })
        .withFailureHandler(err => {
          clearTimeout(timeoutId);
          hideLoader();
          alert(err.message);
        })
        .transformQuoteToInvoice(editingId);
    }
  </script>
</body>
</html>
